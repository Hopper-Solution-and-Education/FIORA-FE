name: Deploy to Vercel

on:
  push:
    branches:
      - develop
      - staging
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for Prisma schema changes
        id: check-prisma
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q 'prisma/schema.prisma'; then
            echo "Prisma schema changed"
            echo "PRISMA_CHANGED=true" >> $GITHUB_ENV
          else
            echo "No changes in Prisma schema"
            echo "PRISMA_CHANGED=false" >> $GITHUB_ENV
          fi

      - name: Run Prisma pull and generate if schema changed
        if: env.PRISMA_CHANGED == 'true'
        run: |
          npx prisma pull
          npx prisma generate

      - name: Run linting
        run: npm run lint

      - name: Run build
        run: npm run build

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }} --env NODE_ENV=staging
          else
            vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }} --env NODE_ENV=development
          fi
