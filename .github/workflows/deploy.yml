name: Deploy to Vercel

on:
  push:
    branches:
      - develop
      - staging
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  # Stage 1: Setup and Environment Configuration
  setup:
    name: Setup and Environment
    runs-on: ubuntu-latest
    outputs:
      deploy_env: ${{ steps.set-env.outputs.deploy_env }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "deploy_env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "Using manually selected environment: ${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "deploy_env=production" >> $GITHUB_OUTPUT
            echo "Using production environment for main branch"
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "deploy_env=staging" >> $GITHUB_OUTPUT
            echo "Using staging environment for staging branch"
          else
            echo "deploy_env=development" >> $GITHUB_OUTPUT
            echo "Using development environment for develop branch"
          fi

  # Stage 2: Lint and Check
  lint:
    name: Lint and Check
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for Prisma schema changes
        id: check-prisma
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q 'prisma/schema.prisma'; then
            echo "PRISMA_CHANGED=true" >> $GITHUB_ENV
            echo "Prisma schema changed"
          else
            echo "PRISMA_CHANGED=false" >> $GITHUB_ENV
            echo "No changes in Prisma schema"
          fi

      - name: Run Prisma pull and generate if schema changed
        if: env.PRISMA_CHANGED == 'true'
        run: |
          npx prisma pull
          npx prisma generate

      - name: Run linting
        run: npm run lint

  # Stage 3: Vercel Configuration
  configure-vercel:
    name: Configure Vercel
    needs: [setup, lint]
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      DEPLOY_ENV: ${{ needs.setup.outputs.deploy_env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Link to Vercel Project
        run: |
          echo "Linking to Vercel project..."
          vercel link --token=${{ secrets.VERCEL_TOKEN }} --yes --project=${{ secrets.VERCEL_PROJECT_ID }}

      - name: Pull Vercel Environment Variables
        run: |
          echo "Pulling Vercel environment variables..."
          vercel env pull .env.production.local --token=${{ secrets.VERCEL_TOKEN }} --environment=${{ env.DEPLOY_ENV }} --yes

      - name: Sync Environment Variables to Vercel
        if: hashFiles('.env.production.local') != ''
        run: |
          echo "Syncing environment variables to Vercel..."
          node scripts/setup-vercel.mjs --ci

  # Stage 4: Deploy to Vercel
  deploy:
    name: Deploy to Vercel
    needs: [setup, configure-vercel]
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      DEPLOY_ENV: ${{ needs.setup.outputs.deploy_env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Deploy to Vercel
        id: deploy
        run: |
          echo "Deploying to Vercel (${{ env.DEPLOY_ENV }} environment)..."
          if [[ "${{ env.DEPLOY_ENV }}" == "production" ]]; then
            DEPLOYMENT_URL=$(vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --yes)
          else
            DEPLOYMENT_URL=$(vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }} --env NODE_ENV=${{ env.DEPLOY_ENV }} --yes)
          fi
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOYMENT_URL"

  # Stage 5: Post-Deployment Notifications
  notify:
    name: Post-Deployment Notifications
    needs: [setup, deploy]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Comment on commit/PR with deployment status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deploymentUrl = '${{ needs.deploy.outputs.deployment_url }}';
            const environment = '${{ needs.setup.outputs.deploy_env }}';

            // Determine if this is a PR or a direct commit
            const isPR = !!context.payload.pull_request;

            let commentBody = `## ðŸš€ Vercel Deployment\n\n`;
            commentBody += `**Environment:** ${environment}\n`;
            commentBody += `**Status:** âœ… Deployed successfully\n`;
            commentBody += `**Preview URL:** [${deploymentUrl}](${deploymentUrl})\n\n`;
            commentBody += `You can view the deployment by clicking the preview URL above.`;

            if (isPR) {
              // Comment on PR
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
            } else {
              // Comment on commit
              github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: commentBody
              });
            }
