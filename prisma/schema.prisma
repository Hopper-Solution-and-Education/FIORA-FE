datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "linux-musl-arm64-openssl-3.0.x"]
  previewFeatures = ["fullTextSearchPostgres"]
}

model User {
  id             String               @id @default(uuid()) @db.Uuid
  name           String?
  email          String               @unique
  password       String?
  emailVerified  Boolean?             @default(false)
  image          String?
  isDeleted      Boolean              @default(false)
  deletedAt      DateTime?
  authentication UserAuthentication[]
  sessions       Session[]
  accounts       Account[]            @relation("UserAccounts")
  categories     Category[]           @relation("UserCategories")
  transactions   Transaction[]        @relation("UserTransactions")
  products       Product[]            @relation("UserProducts")
  partners       Partner[]            @relation("UserPartners")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  @@index([isDeleted])
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique
  userId       String   @db.Uuid
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid
}

model Account {
  id               String        @id @default(uuid()) @db.Uuid
  userId           String        @db.Uuid
  icon             String?
  name             String        @db.VarChar(50)
  description      String?       @db.VarChar(1000)
  type             AccountType   @default(Payment)
  currency         Currency      @default(VND)
  limit            Decimal?      @default(0) @db.Decimal(13, 2)
  balance          Decimal?      @default(0) @db.Decimal(13, 2)
  parentId         String?       @db.Uuid
  parent           Account?      @relation("ChildAccounts", fields: [parentId], references: [id])
  children         Account[]     @relation("ChildAccounts")
  user             User          @relation("UserAccounts", fields: [userId], references: [id])
  fromTransactions Transaction[] @relation("FromAccount")
  toTransactions   Transaction[] @relation("ToAccount")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  @@index([userId])
  @@index([parentId])
}

model UserAuthentication {
  id                String  @id @default(uuid()) @db.Uuid
  userId            String  @unique @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  @@unique([provider, providerAccountId])
}

model Product {
  id           String               @id @default(uuid()) @db.Uuid
  userId       String               @db.Uuid
  catId        String               @db.Uuid
  type         ProductType
  icon         String
  name         String               @db.VarChar(50)
  description  String?              @db.VarChar(1000)
  price        Decimal              @db.Decimal(13, 2)
  taxRate      Decimal?             @db.Decimal(4, 2)
  items        Json?                @db.Json
  user         User                 @relation("UserProducts", fields: [userId], references: [id])
  category     Category             @relation("CategoryProducts", fields: [catId], references: [id])
  // Quan hệ nhiều-nhiều với Transaction thông qua bảng trung gian
  transactions ProductTransaction[] @relation("ProductTransactions")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  @@index([userId]) // For querying active products for a user
  @@index([catId]) // For category-based product queries
}

model Transaction {
  id             String          @id @default(uuid()) @db.Uuid
  userId         String?         @db.Uuid
  date           DateTime        @db.Date
  type           TransactionType
  amount         Decimal         @db.Decimal(13, 2)
  fromAccountId  String?         @db.Uuid
  fromCategoryId String?         @db.Uuid
  toAccountId    String?         @db.Uuid
  toCategoryId   String?         @db.Uuid
  products       Json?
  partnerId      String?         @db.Uuid
  remark         String?         @db.VarChar(255)
  isDeleted      Boolean         @default(false)
  deletedAt      DateTime?

  user             User?                @relation("UserTransactions", fields: [userId], references: [id])
  fromAccount      Account?             @relation("FromAccount", fields: [fromAccountId], references: [id])
  fromCategory     Category?            @relation("FromCategory", fields: [fromCategoryId], references: [id])
  toAccount        Account?             @relation("ToAccount", fields: [toAccountId], references: [id])
  toCategory       Category?            @relation("ToCategory", fields: [toCategoryId], references: [id])
  partner          Partner?             @relation("PartnerTransactions", fields: [partnerId], references: [id])
  // Quan hệ nhiều-nhiều với Product thông qua bảng trung gian
  productsRelation ProductTransaction[] @relation("ProductTransactions")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  updatedBy String? @db.Uuid

  @@index([date]) // Add index for date queries
  @@index([type]) // Add index for filtering by transaction type
  @@index([userId, date]) // Composite index for user's transactions by date
  @@index([userId, type, date]) // For financial reports by type and date range
}

// Bảng trung gian cho quan hệ nhiều-nhiều giữa Product và Transaction
model ProductTransaction {
  productId     String @db.Uuid
  transactionId String @db.Uuid

  product     Product     @relation("ProductTransactions", fields: [productId], references: [id])
  transaction Transaction @relation("ProductTransactions", fields: [transactionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  @@id([productId, transactionId]) // Khóa chính composite
}

model Partner {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @db.Uuid
  logo        String?
  name        String    @db.VarChar(255)
  identify    String?   @db.VarChar(50)
  dob         DateTime? @db.Date
  taxNo       String?   @db.VarChar(20)
  address     String?   @db.VarChar(255)
  email       String?   @db.VarChar(50)
  phone       String?   @db.VarChar(50)
  description String?   @db.VarChar(1000)
  children    Json?     @db.Json

  user         User          @relation("UserPartners", fields: [userId], references: [id])
  transactions Transaction[] @relation("PartnerTransactions")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@id([identifier, token])
}

model Section {
  id           String      @id @default(uuid()) @db.Uuid
  section_type SectionType
  name         String
  order        Int
  medias       Media[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid
}

model Media {
  id            String    @id @default(uuid()) @db.Uuid
  media_type    MediaType
  media_url     String? // Dành cho hình ảnh/video
  embed_code    String? // Dành cho video nhúng (YouTube, Vimeo,...)
  description   String?
  uploaded_by   String?
  uploaded_date DateTime  @default(now())
  section_id    String?   @db.Uuid
  section       Section?  @relation(fields: [section_id], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid
}

model Category {
  id               String        @id @default(uuid()) @db.Uuid
  userId           String        @db.Uuid
  type             CategoryType
  icon             String
  tax_rate         Decimal       @db.Decimal(13, 2)
  name             String        @db.VarChar(50)
  description      String?       @db.VarChar(1000)
  parentId         String?       @db.Uuid
  parent           Category?     @relation("SubCategories", fields: [parentId], references: [id], onDelete: Cascade)
  subCategories    Category[]    @relation("SubCategories")
  user             User          @relation("UserCategories", fields: [userId], references: [id], onDelete: Cascade)
  fromTransactions Transaction[] @relation("FromCategory")
  toTransactions   Transaction[] @relation("ToCategory")
  products         Product[]     @relation("CategoryProducts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   @db.Uuid
  updatedBy String?  @db.Uuid

  @@index([userId])
  @@index([parentId])
}

// Các enum
enum MediaType {
  IMAGE
  VIDEO
  EMBEDDED
}

// Kien - landing page - Section type cho image
enum SectionType {
  BANNER
  VISION_MISSION
  KPS
  PARTNER_LOGO
}

enum CategoryType {
  Expense
  Income
}

enum AccountType {
  Payment
  Saving
  CreditCard
  Debt
  Lending
}

enum Currency {
  VND
  USD
}

enum TransactionType {
  Expense
  Income
  Transfer
}

enum ProductType {
  Product
  Service
}
